var codeVer="0.0.1";var http=require("http");var path=require("path");var request=require("request");var request2=require("request");var express=require("express");var bodyParser=require("body-parser");var session=require("express-session");var EventSource=require("eventsource");var isStreaming=false;var serviceStartDt=getDtNow();var lastEventDt=null;var SUPER_SECRET_KEY="bmVzdG1hbmdlcnRvbmVzdG8NCg==";var NEST_API_URL="https://developer-api.nest.com";var app=express();app.post("/stream",function(e,d){var c=e.headers.token;var g=e.headers.callback;var h=e.headers.connstatus;console.log("streamOn: "+h);var a=e.headers.port;var b=e.headers.sttoken;var f=new EventSource(NEST_API_URL+"?auth="+c);if(c&&h=="true"){f.addEventListener("put",function(k){var j=k.data;var i={uri:g+"/receiveEventData?access_token="+b,method:"POST",body:j};console.log("New Event Data Received...");lastEventDt=getDtNow();request(i,function(n,m,l){if(!n&&m.statusCode==200){console.log(l.id)}else{if(n){console.log(n)}}});isStreaming=true});f.addEventListener("open",function(i){console.log("SmartThings Connection Opened!");isStreaming=true;d.send("SmartThings Connected")});f.addEventListener("auth_revoked",function(i){console.log("Stream Authentication token was revoked.");isStreaming=false;f.close()});f.onerror=function(i){console.error("Stream Error: "+i.message);isStreaming=false;f.close()};f.addEventListener("error",function(i){if(i.readyState==EventSource.CLOSED){console.error("Stream Connection was closed! ",i)}else{console.error("A Stream unknown error occurred: ",i)}isStreaming=false;f.close()},false)}else{if(c&&h=="false"){f.close();console.log("SmartThings Connection Closed!");isStreaming=false}}});app.post("/status",function(c,b){console.log("");console.log("Status request received...");var d=require("request");var e=c.headers.callback;var a=c.headers.token;console.log("streaming: "+isStreaming);console.log("serviceStartDt: "+serviceStartDt);console.log("version: "+codeVer);console.log("lastEvtDt: "+lastEventDt);if(e&&a){d({url:e+"/streamStatus?access_token="+a,method:"POST",json:{streaming:isStreaming,version:codeVer,startupDt:serviceStartDt,lastEvtDt:lastEventDt}},function(h,g,f){if(h){console.log(h)}else{}})}});app.use(bodyParser.json());app.use(bodyParser.urlencoded({extended:false}));app.use(session({secret:SUPER_SECRET_KEY,resave:false,saveUninitialized:false}));function getIPAddress(){var d=require("os").networkInterfaces();for(var a in d){var e=d[a];for(var c=0;c<e.length;c++){var b=e[c];if(b.family==="IPv4"&&b.address!=="127.0.0.1"&&!b.internal){return b.address}}}return"0.0.0.0"}function getDtNow(){var a=new Date();return a.toISOString()}var address=getIPAddress();var port=process.env.PORT||3000;app.set("port",port);var server=http.createServer(app);server.listen(port);console.info("NST Event Stream Server is Running on ("+address+") Port: "+port);console.info("Send a Post Command to http://"+address+":"+port+'/stream with this Body (token: "your_auth_token") to Start the Stream');